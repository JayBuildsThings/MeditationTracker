<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Meditation Tracker (Local)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* Dark gray track */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* Medium gray thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter gray on hover */
        }
        /* Custom font for a clean look */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#111827',
                        'secondary-dark': '#1f2937',
                        'accent-green': '#10b981',
                        'accent-green-hover': '#059669',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-primary-dark text-gray-100 min-h-screen flex items-start justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-lg mt-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-accent-green">Mindful Tracker</h1>
            <p class="text-gray-400 mt-1">Local logging, minutes saved only in this browser.</p>
        </header>

        <!-- Status & Input Card -->
        <div id="app-card" class="bg-secondary-dark p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">

            <!-- Current Day Summary -->
            <div class="text-center mb-8 bg-gray-800 p-4 rounded-xl shadow-inner">
                <h2 class="text-xl font-semibold text-gray-200">Today's Focus <span id="current-date"></span></h2>
                <p class="text-5xl font-bold mt-2 text-accent-green">
                    <span id="daily-total">0</span><span class="text-3xl ml-1 font-light text-gray-400">min</span>
                </p>
                <p id="today-message" class="text-sm mt-2 text-gray-400">Keep up the good work!</p>
            </div>

            <!-- Log Input Form -->
            <div class="flex flex-col space-y-4">
                <label for="minutes-input" class="text-lg font-medium text-gray-300">Minutes Meditated</label>
                <input
                    type="number"
                    id="minutes-input"
                    placeholder="e.g., 10"
                    min="1"
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-50 focus:outline-none focus:ring-2 focus:ring-accent-green text-2xl"
                    aria-label="Minutes Meditated"
                    inputmode="numeric"
                />
                <button
                    id="log-button"
                    onclick="logMeditation()"
                    class="w-full py-3 mt-4 bg-accent-green text-primary-dark font-bold text-lg rounded-xl transition duration-150 ease-in-out hover:bg-accent-green-hover shadow-lg shadow-accent-green/30"
                >
                    Log Minutes
                </button>
            </div>
            
            <!-- Message Box for Alerts (Instead of alert()) -->
            <div id="message-box" class="mt-4 text-center text-sm p-3 rounded-lg hidden" role="alert"></div>
            
        </div>

        <!-- Weekly Summary -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">Past 7 Days</h2>
            <div id="weekly-summary" class="bg-secondary-dark p-4 rounded-2xl border border-gray-700 grid grid-cols-7 text-center gap-1 overflow-x-auto whitespace-nowrap">
                <div class="col-span-7 p-4 text-gray-500" id="loading-indicator">
                    Loading history...
                </div>
            </div>
            
            <!-- New History Button -->
            <button
                onclick="openHistoryModal()"
                class="mt-4 w-full py-2 bg-gray-700 text-gray-300 font-medium rounded-xl transition duration-150 ease-in-out hover:bg-gray-600 shadow-md"
            >
                View All History
            </button>
        </div>
        
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden" onclick="closeHistoryModal()">
        <div class="bg-secondary-dark w-full max-w-sm max-h-[90vh] rounded-2xl p-6 shadow-2xl overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h3 class="text-2xl font-bold text-accent-green">Complete Log</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-100 transition-colors text-3xl leading-none font-light">&times;</button>
            </div>
            <div id="history-list" class="space-y-2">
                <!-- History items will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL CONSTANTS ---
        const STORAGE_KEY = 'meditation_daily_totals';

        // --- UTILITY FUNCTIONS ---

        /**
         * Gets the date key for today (YYYY-MM-DD).
         */
        function getTodayDateKey() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        /**
         * Converts a YYYY-MM-DD date key to a short day name (e.g., 'Mon', 'Today').
         */
        function getDayName(dateKey) {
            const date = new Date(dateKey + 'T00:00:00'); // Ensure date is treated as local midnight
            const todayKey = getTodayDateKey();
            
            if (dateKey === todayKey) {
                return 'Today';
            }
            
            // Check for yesterday
            const yesterday = new Date(new Date().getTime());
            yesterday.setDate(yesterday.getDate() - 1);
            if (dateKey === yesterday.toISOString().split('T')[0].substring(0, 10)) {
                return 'Yest';
            }

            return date.toLocaleDateString('en-US', { weekday: 'short' });
        }

        /**
         * Shows a temporary message to the user.
         */
        function showMessage(text, className) {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.className = `mt-4 text-center text-sm p-3 rounded-lg ${className} text-gray-100`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }

        // --- LOCAL STORAGE FUNCTIONS ---

        /**
         * Loads the daily totals map from Local Storage.
         * Returns an object mapping dateKey to total minutes: { 'YYYY-MM-DD': minutes }
         */
        function loadDailyTotals() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.error("Error reading from Local Storage:", error);
                return {};
            }
        }

        /**
         * Saves the daily totals map to Local Storage.
         */
        function saveDailyTotals(totals) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(totals));
            } catch (error) {
                console.error("Error writing to Local Storage:", error);
                showMessage("Warning: Failed to save data to browser storage.", 'bg-red-800');
            }
        }

        // --- CORE APPLICATION LOGIC ---

        /**
         * Function to add a new meditation log and update the UI.
         */
        function logMeditation() {
            const inputElement = document.getElementById('minutes-input');
            const minutes = parseInt(inputElement.value, 10);
            
            if (isNaN(minutes) || minutes <= 0) {
                showMessage("Please enter a valid number of minutes.", 'bg-yellow-700');
                return;
            }

            const dateKey = getTodayDateKey();
            const dailyTotals = loadDailyTotals();

            // 1. Update the total for today
            dailyTotals[dateKey] = (dailyTotals[dateKey] || 0) + minutes;
            
            // 2. Save the updated map
            saveDailyTotals(dailyTotals);

            // 3. Update the UI
            processAndDisplayLogs(dailyTotals);
            
            showMessage(`Successfully logged ${minutes} minutes!`, 'bg-accent-green-hover');
            inputElement.value = ''; // Clear input
        }

        /**
         * Updates the UI (Today's Total and Weekly Chart) based on the daily totals map.
         */
        function processAndDisplayLogs(dailyTotals) {
            const todayKey = getTodayDateKey();
            
            // 1. Get the last 7 days' date keys
            const sevenDays = [];
            const now = new Date();
            for (let i = 6; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(now.getDate() - i);
                sevenDays.push(d.toISOString().split('T')[0].substring(0, 10));
            }

            // 2. Update the Today's Total and Message
            const todayTotal = dailyTotals[todayKey] || 0;
            document.getElementById('daily-total').textContent = todayTotal;
            document.getElementById('current-date').textContent = `(${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;

            if (todayTotal === 0) {
                document.getElementById('today-message').textContent = "Start your session now!";
            } else if (todayTotal < 15) {
                document.getElementById('today-message').textContent = "A great start to your day!";
            } else {
                document.getElementById('today-message').textContent = "Excellent focus and consistency!";
            }
            
            // 3. Render the Weekly Summary
            const summaryContainer = document.getElementById('weekly-summary');
            summaryContainer.innerHTML = ''; // Clear previous content

            // Find the max total for scaling the bar chart visually
            const allTotals = sevenDays.map(dateKey => dailyTotals[dateKey] || 0);
            const maxTotal = Math.max(...allTotals);
            
            sevenDays.forEach(dateKey => {
                const total = dailyTotals[dateKey] || 0;
                const dayName = getDayName(dateKey);
                
                // Calculate bar height percentage (min 5% if > 0 to be visible)
                let heightPercent = 0;
                if (total > 0 && maxTotal > 0) {
                    heightPercent = Math.max(5, (total / maxTotal) * 100);
                }
                
                // Highlight today's bar
                const isToday = dateKey === todayKey;
                const barClasses = isToday 
                    ? 'bg-accent-green shadow-lg shadow-accent-green/50' 
                    : 'bg-gray-600 hover:bg-gray-500 transition-colors';
                const textClasses = isToday 
                    ? 'text-accent-green font-bold' 
                    : 'text-gray-400';

                const dayElement = `
                    <div class="flex flex-col items-center justify-end h-32 p-1 pt-0 min-w-[50px]">
                        <div class="text-xs ${textClasses} mb-1">${total}</div>
                        <div class="w-4 h-full flex items-end">
                            <div 
                                class="w-full rounded-t-full ${barClasses}" 
                                style="height: ${heightPercent}%;"
                                title="${dayName}: ${total} minutes"
                            ></div>
                        </div>
                        <div class="text-xs mt-2 ${textClasses}">${dayName}</div>
                    </div>
                `;
                summaryContainer.insertAdjacentHTML('beforeend', dayElement);
            });
            
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        // --- HISTORY MODAL FUNCTIONS ---

        /**
         * Populates and opens the history modal.
         */
        function openHistoryModal() {
            const dailyTotals = loadDailyTotals();
            const historyListContainer = document.getElementById('history-list');
            historyListContainer.innerHTML = '';

            // Convert object to array of {date: 'YYYY-MM-DD', minutes: N}
            let historyArray = Object.keys(dailyTotals)
                .map(dateKey => ({
                    date: dateKey,
                    minutes: dailyTotals[dateKey]
                }))
                // Filter out entries with 0 minutes
                .filter(entry => entry.minutes > 0);

            // Sort by date descending (most recent first)
            historyArray.sort((a, b) => b.date.localeCompare(a.date));

            if (historyArray.length === 0) {
                historyListContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No logged history yet.</p>';
            } else {
                historyArray.forEach(entry => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg border border-gray-600';
                    
                    // Format date for display
                    const displayDate = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });

                    listItem.innerHTML = `
                        <span class="text-gray-200 font-medium">${displayDate}</span>
                        <span class="text-accent-green font-bold">${entry.minutes} min</span>
                    `;
                    historyListContainer.appendChild(listItem);
                });
            }

            document.getElementById('history-modal').classList.remove('hidden');
        }

        /**
         * Closes the history modal.
         */
        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }


        // --- INITIALIZATION ---
        window.onload = function() {
            // Load existing data on startup
            const initialTotals = loadDailyTotals();
            processAndDisplayLogs(initialTotals);
        };
    </script>
</body>
</html>
