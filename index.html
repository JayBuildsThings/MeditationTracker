<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Meditation Tracker (Local)</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* Dark gray track */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* Medium gray thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter gray on hover */
        }
        /* Custom font for a clean look */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#111827',
                        'secondary-dark': '#1f2937',
                        'accent-green': '#10b981',
                        'accent-green-hover': '#059669',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-primary-dark text-gray-100 min-h-screen flex items-start justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-lg mt-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-accent-green">Mindful Tracker</h1>
            <p class="text-gray-400 mt-1">Local logging, minutes saved only in this browser.</p>
        </header>

        <!-- Status & Input Card -->
        <div id="app-card" class="bg-secondary-dark p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">

            <!-- Current Day Summary -->
            <div class="text-center mb-8 bg-gray-800 p-4 rounded-xl shadow-inner">
                <h2 class="text-xl font-semibold text-gray-200">Today's Focus <span id="current-date"></span></h2>
                <p class="text-5xl font-bold mt-2 text-accent-green">
                    <span id="daily-total">0</span><span class="text-3xl ml-1 font-light text-gray-400">min</span>
                </p>
                <p id="today-message" class="text-sm mt-2 text-gray-400">Keep up the good work!</p>
            </div>

            <!-- Log Input Form -->
            <div class="flex flex-col space-y-4">
                <label for="minutes-input" class="text-lg font-medium text-gray-300">Minutes Meditated</label>
                <input
                    type="number"
                    id="minutes-input"
                    placeholder="e.g., 10"
                    min="1"
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-50 focus:outline-none focus:ring-2 focus:ring-accent-green text-2xl"
                    aria-label="Minutes Meditated"
                    inputmode="numeric"
                />
                <button
                    id="log-button"
                    onclick="logMeditation()"
                    class="w-full py-3 mt-4 bg-accent-green text-primary-dark font-bold text-lg rounded-xl transition duration-150 ease-in-out hover:bg-accent-green-hover shadow-lg shadow-accent-green/30"
                >
                    Log Minutes
                </button>
            </div>
            
            <!-- Message Box for Alerts (Instead of alert()) -->
            <div id="message-box" class="mt-4 text-center text-sm p-3 rounded-lg hidden" role="alert"></div>
            
        </div>

        <!-- Weekly Summary -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">Past 7 Days</h2>
            <div id="weekly-summary" class="bg-secondary-dark p-4 rounded-2xl border border-gray-700 grid grid-cols-7 text-center gap-1 overflow-x-auto whitespace-nowrap">
                <div class="col-span-7 p-4 text-gray-500" id="loading-indicator">
                    Loading history...
                </div>
            </div>
            
            <!-- History Button -->
            <button
                onclick="openHistoryModal()"
                class="mt-4 w-full py-2 bg-gray-700 text-gray-300 font-medium rounded-xl transition duration-150 ease-in-out hover:bg-gray-600 shadow-md"
            >
                View All History
            </button>
        </div>
        
        <!-- Dual Buttons -->
        <div class="mt-4 flex space-x-4">
            <a 
                href="why_story.html" 
                class="w-1/2 py-2 text-center bg-gray-700 text-gray-300 font-medium rounded-xl transition duration-150 ease-in-out hover:bg-gray-600 shadow-md"
            >
                Why
            </a>
            <a 
                href="support.html" 
                class="w-1/2 py-2 text-center bg-gray-700 text-gray-300 font-medium rounded-xl transition duration-150 ease-in-out hover:bg-gray-600 shadow-md"
            >
                Buy me a coffee
            </a>
        </div>

    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden" onclick="closeHistoryModal()">
        <div class="bg-secondary-dark w-full max-w-sm max-h-[90vh] rounded-2xl p-6 shadow-2xl overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h3 class="text-2xl font-bold text-accent-green">Complete Log</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-100 transition-colors text-3xl leading-none font-light">&times;</button>
            </div>
            <div id="history-list" class="space-y-2">
                <!-- History items will be inserted here -->
            </div>
        </div>
    </div>

    <!-- PWA Install Modal -->
    <div id="install-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-secondary-dark w-full max-w-xs rounded-2xl p-6 shadow-2xl border border-accent-green text-center">
            <div class="mb-4 flex justify-center">
                <div class="w-16 h-16 rounded-full bg-accent-green flex items-center justify-center shadow-lg shadow-accent-green/40">
                    <svg class="w-8 h-8 text-primary-dark" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            <h3 class="text-xl font-bold text-gray-100 mb-2">Install App?</h3>
            <p class="text-gray-400 text-sm mb-6">Install this tracker on your home screen for quick access and offline use.</p>
            
            <div class="flex flex-col space-y-3">
                <button onclick="handleInstallYes()" class="w-full py-2 bg-accent-green text-primary-dark font-bold rounded-lg hover:bg-accent-green-hover transition-colors">
                    Install Now
                </button>
                <button onclick="handleInstallNo()" class="w-full py-2 bg-transparent text-gray-400 font-medium hover:text-gray-200 transition-colors">
                    No, thanks
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- PWA & INSTALLATION LOGIC ---
        
        let deferredPrompt;
        const INSTALL_DECLINED_KEY = 'pwa_install_declined_time';
        const DAYS_TO_WAIT = 30;

        // 1. Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // 2. Listen for 'beforeinstallprompt'
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;

            // Check logic: Have they declined recently?
            checkAndShowInstallModal();
        });

        function checkAndShowInstallModal() {
            const lastDeclined = localStorage.getItem(INSTALL_DECLINED_KEY);
            
            if (lastDeclined) {
                const declinedTime = parseInt(lastDeclined, 10);
                const currentTime = Date.now();
                const daysSince = (currentTime - declinedTime) / (1000 * 60 * 60 * 24);

                // If declined less than 30 days ago, do not show prompt
                if (daysSince < DAYS_TO_WAIT) {
                    console.log(`Install prompt declined ${Math.floor(daysSince)} days ago. Waiting 30 days.`);
                    return;
                }
            }

            // If we made it here, show the custom modal
            document.getElementById('install-modal').classList.remove('hidden');
        }

        async function handleInstallYes() {
            // Hide our custom modal
            document.getElementById('install-modal').classList.add('hidden');
            
            if (deferredPrompt) {
                // Show the actual browser prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                // We no longer need the prompt. Clear it.
                deferredPrompt = null;
            }
        }

        function handleInstallNo() {
            // Hide modal
            document.getElementById('install-modal').classList.add('hidden');
            
            // Save current timestamp to local storage
            localStorage.setItem(INSTALL_DECLINED_KEY, Date.now().toString());
            console.log('User declined install. Setting 30 day cooldown.');
        }


        // --- EXISTING APP LOGIC (UNCHANGED) ---
        const STORAGE_KEY = 'meditation_daily_totals';

        function getTodayDateKey() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        function getDayName(dateKey) {
            const date = new Date(dateKey + 'T00:00:00');
            const todayKey = getTodayDateKey();
            if (dateKey === todayKey) return 'Today';
            
            const yesterday = new Date(new Date().getTime());
            yesterday.setDate(yesterday.getDate() - 1);
            if (dateKey === yesterday.toISOString().split('T')[0].substring(0, 10)) return 'Yest';

            return date.toLocaleDateString('en-US', { weekday: 'short' });
        }

        function showMessage(text, className) {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.className = `mt-4 text-center text-sm p-3 rounded-lg ${className} text-gray-100`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }

        function loadDailyTotals() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.error("Error reading from Local Storage:", error);
                return {};
            }
        }

        function saveDailyTotals(totals) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(totals));
            } catch (error) {
                console.error("Error writing to Local Storage:", error);
                showMessage("Warning: Failed to save data to browser storage.", 'bg-red-800');
            }
        }

        function logMeditation() {
            const inputElement = document.getElementById('minutes-input');
            const minutes = parseInt(inputElement.value, 10);
            
            if (isNaN(minutes) || minutes <= 0) {
                showMessage("Please enter a valid number of minutes.", 'bg-yellow-700');
                return;
            }

            const dateKey = getTodayDateKey();
            const dailyTotals = loadDailyTotals();

            dailyTotals[dateKey] = (dailyTotals[dateKey] || 0) + minutes;
            saveDailyTotals(dailyTotals);
            processAndDisplayLogs(dailyTotals);
            
            showMessage(`Successfully logged ${minutes} minutes!`, 'bg-accent-green-hover');
            inputElement.value = ''; 
        }

        function processAndDisplayLogs(dailyTotals) {
            const todayKey = getTodayDateKey();
            const sevenDays = [];
            const now = new Date();
            for (let i = 6; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(now.getDate() - i);
                sevenDays.push(d.toISOString().split('T')[0].substring(0, 10));
            }

            const todayTotal = dailyTotals[todayKey] || 0;
            document.getElementById('daily-total').textContent = todayTotal;
            document.getElementById('current-date').textContent = `(${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;

            if (todayTotal === 0) {
                document.getElementById('today-message').textContent = "Start your session now!";
            } else if (todayTotal < 15) {
                document.getElementById('today-message').textContent = "A great start to your day!";
            } else {
                document.getElementById('today-message').textContent = "Excellent focus and consistency!";
            }
            
            const summaryContainer = document.getElementById('weekly-summary');
            summaryContainer.innerHTML = '';

            const allTotals = sevenDays.map(dateKey => dailyTotals[dateKey] || 0);
            const maxTotal = Math.max(...allTotals);
            
            sevenDays.forEach(dateKey => {
                const total = dailyTotals[dateKey] || 0;
                const dayName = getDayName(dateKey);
                
                let heightPercent = 0;
                if (total > 0 && maxTotal > 0) {
                    heightPercent = Math.max(5, (total / maxTotal) * 100);
                }
                
                const isToday = dateKey === todayKey;
                const barClasses = isToday 
                    ? 'bg-accent-green shadow-lg shadow-accent-green/50' 
                    : 'bg-gray-600 hover:bg-gray-500 transition-colors';
                const textClasses = isToday 
                    ? 'text-accent-green font-bold' 
                    : 'text-gray-400';

                const dayElement = `
                    <div class="flex flex-col items-center justify-end h-32 p-1 pt-0 min-w-[50px]">
                        <div class="text-xs ${textClasses} mb-1">${total}</div>
                        <div class="w-4 h-full flex items-end">
                            <div 
                                class="w-full rounded-t-full ${barClasses}" 
                                style="height: ${heightPercent}%;"
                                title="${dayName}: ${total} minutes"
                            ></div>
                        </div>
                        <div class="text-xs mt-2 ${textClasses}">${dayName}</div>
                    </div>
                `;
                summaryContainer.insertAdjacentHTML('beforeend', dayElement);
            });
            
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        function openHistoryModal() {
            const dailyTotals = loadDailyTotals();
            const historyListContainer = document.getElementById('history-list');
            historyListContainer.innerHTML = '';

            let historyArray = Object.keys(dailyTotals)
                .map(dateKey => ({
                    date: dateKey,
                    minutes: dailyTotals[dateKey]
                }))
                .filter(entry => entry.minutes > 0);

            historyArray.sort((a, b) => b.date.localeCompare(a.date));

            if (historyArray.length === 0) {
                historyListContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No logged history yet.</p>';
            } else {
                historyArray.forEach(entry => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg border border-gray-600';
                    const displayDate = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    listItem.innerHTML = `
                        <span class="text-gray-200 font-medium">${displayDate}</span>
                        <span class="text-accent-green font-bold">${entry.minutes} min</span>
                    `;
                    historyListContainer.appendChild(listItem);
                });
            }

            document.getElementById('history-modal').classList.remove('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        window.onload = function() {
            const initialTotals = loadDailyTotals();
            processAndDisplayLogs(initialTotals);
        };
    </script>
</body>
</html>
